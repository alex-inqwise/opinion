(function(f){f.fn.conditionsBuilder=function(j){if(j=="data"){var i=f(this).eq(0).data("conditionsBuilder");return i.collectData()}else{return f(this).each(function(){var k=new a(this,j);f(this).data("conditionsBuilder",k)})}};function a(j,i){this.element=f(j);this.options=i||{};this.init()}a.prototype={init:function(){this.fields=this.options.fields;this.data=this.options.data||{all:[]};var i=this.buildRules(this.data);this.element.html(i)},collectData:function(){return this.collectDataFromNode(this.element.find("> .conditional"))},collectDataFromNode:function(k){var i=null;var l=this;if(k.is(".conditional")){i=k.find("> .all-any-none-wrapper > .all-any-none").val()}if(i){var j={};j[i]=[];k.find("> .conditional, > .rule").each(function(){j[i].push(l.collectDataFromNode(f(this)))});return j}else{return{name:k.find(".field").val(),operator:k.find(".operator").val(),value:k.find(".value").val()}}},buildRules:function(i){return this.buildConditional(i)||this.buildRule(i)},buildConditional:function(l){var n;if(l.all){n="all"}else{if(l.any){n="any"}else{if(l.none){n="none"}}}if(!n){return}var p=f("<div>",{"class":"conditional "+n});var k=f("<div>",{"class":"all-any-none-wrapper"});k.append(f("<strong>",{text:"If"}));var j=f("<select>",{"class":"all-any-none"});j.append(f("<option>",{value:"all",text:"All",selected:n=="all"}));j.append(f("<option>",{value:"any",text:"Any",selected:n=="any"}));j.append(f("<option>",{value:"none",text:"None",selected:n=="none"}));k.append(j);k.append(f("<strong>",{text:"of the following conditions are met:"}));p.append(k);var o=l[n];for(var m=0;m<o.length;m++){p.append(this.buildRules(o[m]))}return p},firstRule:false,buildRule:function(i){var m=f("<div>",{"class":"rule "+(!this.firstRule?"first-item":"")});var j=d(this.fields,i);var l=h();j.change(b.call(this,l,i));m.append(j);m.append(l);var k=f("<a>",{href:"#","class":"add-rule",text:"Add condition",title:"Add another condition to this rule"});var n=this;k.click(function(p){p.preventDefault();var o=n.fields[0];var q={name:o.value,operator:o.operators[0],value:null};f(this).parent(".rule").after(n.buildRule(q))});m.append(k);m.append(g());j.change();m.find("> .value").val(i.value);if(!this.firstRule){this.firstRule=true}return m},operatorsFor:function(l){for(var j=0;j<this.fields.length;j++){var k=this.fields[j];if(k.name==l){return k.operators}}}};function d(l,k){var j=f("<select>",{"class":"field"});for(var m=0;m<l.length;m++){var o=l[m];var n=f("<option>",{text:o.label,value:o.name,selected:k.name==o.name});n.data("options",o.options);j.append(n)}return j}function h(){var i=f("<select>",{"class":"operator"});i.change(c);return i}function g(){var i=f("<a>",{"class":"remove remove-condition",href:"#",text:"Remove",title:"Remove this condition from this rule"});i.click(e);return i}function e(i){i.preventDefault();f(this).parents(".rule").remove()}function b(k,i){var j=this;return function(p){var l=j.operatorsFor(f(p.target).val());k.empty();for(var n=0;n<l.length;n++){var m=l[n];var o=f("<option>",{text:m.label||m.name,value:m.name,selected:i.operator==m.name});o.data("fieldType",m.fieldType);k.append(o)}k.change()}}function c(p){var q=f(this);var o=q.find("> :selected");var k=q.parents(".rule");var j=k.find(".field");var s=k.find(".value");var m=s.val();switch(o.data("fieldType")){case"none":q.after(f("<input>",{type:"hidden","class":"value"}));break;case"text":q.after(f("<input>",{type:"text","class":"value"}));break;case"textarea":q.after(f("<textarea>",{"class":"value"}));case"select":var r=f("<select>",{"class":"value"});var t=j.find("> :selected").data("options");for(var n=0;n<t.length;n++){var l=t[n];r.append(f("<option>",{text:l.label||l.name,value:l.name}))}q.after(r);break}s.remove()}})(jQuery);