(function(b){b.fn.actionsBuilder=function(d){if(d=="data"){var c=b(this).eq(0).data("actionsBuilder");return c.collectData()}else{return b(this).each(function(){var e=new a(this,d);b(this).data("actionsBuilder",e)})}};function a(d,c){this.element=b(d);this.options=c||{};this.init()}a.prototype={init:function(){this.fields=this.options.fields;this.data=this.options.data||[];var c=this.buildActions(this.data);this.element.html(c)},buildActions:function(e){var c=b("<div>",{"class":"actions"});var k=b("<div>",{"class":"action-buttons"});var m=b("<a>",{href:"#","class":"add",text:"Add Action"});var h=this;m.click(function(i){i.preventDefault();c.append(h.buildAction({}))});k.append(m);c.append(k);for(var f=0;f<e.length;f++){var j=e[f];var d=this.buildAction(j);var g=[j];var l;while(l=g.shift()){d.find(":input[name='"+l.name+"']").val(l.value).change();if(l.fields){g=g.concat(l.fields)}}c.append(d)}return c},buildAction:function(d){var k=this._findField(d.name);var c=b("<div>",{"class":"action"});var h=b("<div>",{"class":"subfields"});var l=b("<select>",{"class":"action-select",name:"action-select"});for(var e=0;e<this.fields.length;e++){var m=this.fields[e];var f=b("<option>",{text:m.label,value:m.name});l.append(f)}var g=this;l.change(function(){var p=b(this).val();var o=g._findField(p);h.empty();if(o.fields){for(var n=0;n<o.fields.length;n++){h.append(g.buildField(o.fields[n]))}}c.attr("class","action "+p)});var j=b("<a>",{href:"#","class":"remove remove-action",text:"Remove Action"});j.click(function(i){i.preventDefault();c.remove()});c.append(l);c.append(h);c.append(j);return c},buildField:function(m){var c=b("<div>",{"class":"field"});var j=b("<div>",{"class":"subfields"});var k=this;var n=b("<label>",{text:m.label});c.append(n);if(m.fieldType=="select"){var n=b("<label>",{text:m.label});var o=b("<select>",{name:m.name});for(var g=0;g<m.options.length;g++){var f=m.options[g];var h=b("<option>",{text:f.label,value:f.name});h.data("optionData",f);o.append(h)}o.change(function(){var q=b(this).find("> :selected");var s=q.data("optionData");j.empty();if(s.fields){for(var p=0;p<s.fields.length;p++){var r=s.fields[p];j.append(k.buildField(r))}}});o.change();c.append(o)}else{if(m.fieldType=="text"){var l=b("<input>",{type:"text",name:m.name});c.append(l)}else{if(m.fieldType=="textarea"){var e="textarea-"+Math.floor(Math.random()*100000);var d=b("<textarea>",{name:m.name,id:e});c.append(d)}}}if(m.hint){c.append(b("<p>",{"class":"hint",text:m.hint}))}c.append(j);return c},collectData:function(c){var e=this;c=c||this.element.find(".action");var d=[];c.each(function(){var g=b(this).find("> :input, > .jstEditor > :input");var f=b(this).find("> .subfields > .field");var h={name:g.attr("name"),value:g.val()};if(f.length>0){h.fields=e.collectData(f)}d.push(h)});return d},_findField:function(e){for(var c=0;c<this.fields.length;c++){var d=this.fields[c];if(d.name==e){return d}}}}})(jQuery);